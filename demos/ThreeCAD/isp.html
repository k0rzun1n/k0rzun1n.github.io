<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js webgl - loaders - 3DS loader</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
			font-family: Monospace;
			background-color: #000;
			color: #fff;
			margin: 0px;
			overflow: hidden;
		}

		#info {
			color: #fff;
			position: absolute;
			top: 10px;
			width: 100%;
			text-align: center;
			z-index: 100;
			display: block;
		}

		#info a,
		.button {
			color: #f00;
			font-weight: bold;
			text-decoration: underline;
			cursor: pointer
		}
	</style>
	<script id="vertex-shader" type="x-shader/x-vertex">
		varying vec3 v_eyespace_normal;
		varying vec3 v_eyespace_position;

		void main(void)
		{
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			vec4 p = modelViewMatrix * vec4( position, 1.0 );
			v_eyespace_position = p.xyz/p.w ;
			v_eyespace_normal = normalize(normalMatrix * normal);
		}
	</script>
	<script id="fragment-shader" type="x-shader/x-fragment">
		vec3  M_ambient = vec3(0.1);
		vec3  M_diffuse = vec3(.5);
		vec3  M_specular = vec3(1);
		vec3  M_emissive = vec3(0.1);
		float M_shininess = 100.;
		float M_alpha = 1.;

		vec3 L_diffuse =   vec3(1.0, 1.0, 1.0);
		vec3 L_ambient =   vec3(0.8, 0.8, 0.8);
		vec3 L_specular =  vec3(0.8, 0.8, 0.8);
		vec3 L_direction = vec3(0.0, -0.5,-0.5);
		// vec3 L_direction = vec3(.0, -0.5,1.);

		float u_highlight = 0.;
		float u_alpha = 1.;
		
		varying vec3 v_eyespace_normal;
		varying vec3 v_eyespace_position;
		
		const float SCREEN_GAMMA = 2.2;
		const vec3 HCOLOR = vec3(1.0,0.71,0.22);
		vec3 cgamma(vec3 c){
			return pow(c, vec3(1.0/SCREEN_GAMMA));
		}
		void main(void)
		{
			vec3 N = v_eyespace_normal;
			vec3 E = normalize(-v_eyespace_position);
			vec3 L = normalize(-L_direction);   
			vec3 R = normalize(-reflect(L,N));  
			vec3 ambient =  L_ambient * M_ambient;  
			float diffuse_factor =  max(dot(N,L), 0.0);
			vec3 diffuse =  L_diffuse * M_diffuse * diffuse_factor;
			vec3 specular =  vec3(0.0);
			if(diffuse_factor>0.0){
				vec3 H = normalize(L + E);
				float specular_factor = pow(max(dot(N,H), 0.0), M_shininess);
				
				// const float leftS=0., rightS=0.000001;
				// specular_factor = min( 1. / (rightS-leftS) / (1.-leftS) * max(specular_factor - leftS, 0.0), 1.);
				
				specular_factor = step(0.001,specular_factor);

				specular = L_specular * M_specular  * specular_factor;
			}
			vec3 emissive = M_emissive;
			const float leftE=0.25, rightE=0.35;
			float edge = min( 1. / (rightE-leftE) / (1.-leftE) * max(N.z-leftE, 0.0), 1.);
			// diffuse *= edge;
			vec3 final_color = emissive + ambient + specular + diffuse;
			final_color = cgamma((1.0 - u_highlight) * final_color + u_highlight * HCOLOR * N.z);
			final_color *= edge;
			gl_FragColor = vec4(final_color,M_alpha * u_alpha); 
			// gl_FragColor = vec4(vec3(edge),M_alpha * u_alpha); 
			// gl_FragColor = vec4(v_eyespace_normal,M_alpha * u_alpha); 
		}
	</script>
</head>

<body>
	<div id="info">
		<a href="http://threejs.org" target="_blank" rel="noopener">three.js</a> - 3DS loader
	</div>

	<script src="three.min.js"></script>
	<script src="OrbitControls.js"></script>
	<script src="TrackballControls.js"></script>
	<script src="TDSLoader.js"></script>
	<script src="OBJLoader.js"></script>

	<script>

		var container, controls;
		var camera, scene, renderer;

		init();
		animate();

		function init() {

			container = document.createElement('div');
			document.body.appendChild(container);

			camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.5, 200);
			// camera.position.z = 70;
			camera.position.y = 2;
			 camera.position.x = 8;

			// controls = new THREE.OrbitControls(camera);
			controls = new THREE.TrackballControls(camera);
			controls.target = new THREE.Vector3(0, 1, 0);
			// controls.rotateSpeed = 0.2;

			scene = new THREE.Scene();
			scene.add(new THREE.HemisphereLight());

			var directionalLight = new THREE.DirectionalLight(0xffeedd);
			directionalLight.position.set(0, 3, 2);
			scene.add(directionalLight);

			//3ds files dont store normal maps
			// var loader = new THREE.TextureLoader();
			// var normal = loader.load('portalgun/textures/normal.jpg');

			// var loader = new THREE.TDSLoader();
			// loader.setPath('portalgun/textures/');
			// loader.load( 'portalgun/portalgun.3ds', function ( object ) {

			// loader.load('mylathe.3ds', function (object) {

			var loader = new THREE.OBJLoader();
			loader.load('diesel_generator.obj', function (object) {

				var shMat = new THREE.ShaderMaterial({
					vertexShader: document.getElementById('vertex-shader').textContent,
					fragmentShader: document.getElementById('fragment-shader').textContent,
					// depthWrite: false,
					// depthTest: false
				})
				object.traverse(function (child) {

					if (child instanceof THREE.Mesh) {

						child.material = shMat;
					}

				});
				// object.rotateX(-Math.PI / 2);
				scene.add(object);

			});



			renderer = new THREE.WebGLRenderer();
			renderer.setClearColor(0x003333, 1);
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			container.appendChild(renderer.domElement);

			window.addEventListener('resize', resize, false);

		}

		function resize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		function animate() {

			controls.update();
			renderer.render(scene, camera);

			requestAnimationFrame(animate);

		}
	</script>

</body>

</html>